services:
  # Web App
  - type: web
    name: menu-system
    env: python
    buildCommand: |
      # Install system packages
      apt-get update && apt-get install -y \
        tesseract-ocr \
        tesseract-ocr-eng \
        libtesseract-dev \
        libleptonica-dev \
        poppler-utils
      
      # Install Python dependencies
      pip install -r requirements.txt
      
      # Verify Tesseract installation
      tesseract --version
      tesseract --list-langs
      
      # Test with Python
      python test_tesseract.py
    startCommand: gunicorn --timeout 120 --workers 2 --threads 2 --worker-class gthread app:app
    envVars:
      - key: PYTHON_VERSION
        value: 3.11.0
      - key: WEB_CONCURRENCY
        value: "2"
      - key: TESSDATA_PREFIX
        value: /usr/share/tesseract-ocr/4.00/tessdata
      - key: TESSERACT_PATH
        value: /usr/bin/tesseract
      - key: LD_LIBRARY_PATH
        value: /usr/lib/x86_64-linux-gnu
    healthCheckPath: /
    plan: starter

  # Worker Service
  - type: worker
    name: menu-worker
    env: python
    buildCommand: |
      # Install system packages
      apt-get update && apt-get install -y \
        tesseract-ocr \
        tesseract-ocr-eng \
        libtesseract-dev \
        libleptonica-dev \
        poppler-utils
      
      # Install Python dependencies
      pip install -r requirements.txt
      
      # Verify Tesseract installation
      tesseract --version
      tesseract --list-langs
      
      # Test with Python
      python test_tesseract.py
    startCommand: python worker.py
    envVars:
      - key: PYTHON_VERSION
        value: 3.11.0
      - key: WEB_CONCURRENCY
        value: "2"
      - key: TESSDATA_PREFIX
        value: /usr/share/tesseract-ocr/4.00/tessdata
      - key: TESSERACT_PATH
        value: /usr/bin/tesseract
      - key: LD_LIBRARY_PATH
        value: /usr/lib/x86_64-linux-gnu 