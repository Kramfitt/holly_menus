services:
  # Web App (Docker-based)
  - type: web
    name: menu-system
    env: docker
    dockerfilePath: Dockerfile.web
    dockerCommand: gunicorn app:app
    buildCommand: |
      # Install packages with sudo
      sudo apt-get update
      sudo apt-get install -y tesseract-ocr tesseract-ocr-eng libtesseract-dev libleptonica-dev poppler-utils
      
      # Verify Tesseract installation
      which tesseract || {
        echo "Tesseract not found in PATH after installation"
        exit 1
      }
      
      tesseract --version || {
        echo "Tesseract installation failed"
        exit 1
      }
      
      tesseract --list-langs || {
        echo "Tesseract languages not properly installed"
        exit 1
      }
      
      # Set up Tesseract path
      TESSERACT_PATH=$(which tesseract)
      echo "Found Tesseract at: $TESSERACT_PATH"
      echo "TESSERACT_PATH=$TESSERACT_PATH" >> $RENDER_ENV_FILE
      
      # Ensure Tesseract is executable
      sudo chmod +x $TESSERACT_PATH
      
      # Add Tesseract directory to PATH
      TESSERACT_DIR=$(dirname $TESSERACT_PATH)
      echo "PATH=$TESSERACT_DIR:$PATH" >> $RENDER_ENV_FILE
      
      # Install Python dependencies
      pip install -r requirements.txt
      
      # Verify Tesseract works with Python
      python test_tesseract.py || {
        echo "Tesseract Python verification failed"
        exit 1
      }
    envVars:
      - key: DOCKER_BUILD
        value: "true"
      - key: RENDER
        value: "true"
      - key: PYTHON_VERSION
        value: 3.11.0
      - key: TESSERACT_PATH
        value: /usr/bin/tesseract
      - key: SUPABASE_URL
        sync: false
      - key: SUPABASE_KEY
        sync: false
      - key: SMTP_SERVER
        sync: false
      - key: SMTP_PORT
        sync: false
      - key: SMTP_USERNAME
        sync: false
      - key: SMTP_PASSWORD
        sync: false
      - key: ADMIN_EMAIL
        sync: false

  # Worker Service (Docker-based)
  - type: worker
    name: menu-worker
    env: docker
    dockerfilePath: Dockerfile.worker
    dockerCommand: python worker.py
    buildCommand: |
      # Install packages with sudo
      sudo apt-get update
      sudo apt-get install -y tesseract-ocr tesseract-ocr-eng libtesseract-dev libleptonica-dev poppler-utils
      
      # Verify Tesseract installation
      which tesseract || {
        echo "Tesseract not found in PATH after installation"
        exit 1
      }
      
      tesseract --version || {
        echo "Tesseract installation failed"
        exit 1
      }
      
      tesseract --list-langs || {
        echo "Tesseract languages not properly installed"
        exit 1
      }
      
      # Set up Tesseract path
      TESSERACT_PATH=$(which tesseract)
      echo "Found Tesseract at: $TESSERACT_PATH"
      echo "TESSERACT_PATH=$TESSERACT_PATH" >> $RENDER_ENV_FILE
      
      # Ensure Tesseract is executable
      sudo chmod +x $TESSERACT_PATH
      
      # Add Tesseract directory to PATH
      TESSERACT_DIR=$(dirname $TESSERACT_PATH)
      echo "PATH=$TESSERACT_DIR:$PATH" >> $RENDER_ENV_FILE
      
      # Install Python dependencies
      pip install -r requirements.txt
      
      # Verify Tesseract works with Python
      python test_tesseract.py || {
        echo "Tesseract Python verification failed"
        exit 1
      }
    envVars:
      - key: DOCKER_BUILD
        value: "true"
      - key: RENDER
        value: "true"
      - key: PYTHON_VERSION
        value: 3.11.0
      - key: TESSERACT_PATH
        value: /usr/bin/tesseract
      - key: SUPABASE_URL
        sync: false
      - key: SUPABASE_KEY
        sync: false
      - key: SMTP_SERVER
        sync: false
      - key: SMTP_PORT
        sync: false
      - key: SMTP_USERNAME
        sync: false
      - key: SMTP_PASSWORD
        sync: false 