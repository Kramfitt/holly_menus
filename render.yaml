services:
  # Web App
  - type: web
    name: menu-system
    env: python
    buildCommand: |
      # Install system packages
      sudo apt-get update
      sudo apt-get install -y tesseract-ocr tesseract-ocr-eng libtesseract-dev libleptonica-dev poppler-utils
      
      # Create a persistent directory for Tesseract
      sudo mkdir -p /opt/tesseract
      sudo cp $(which tesseract) /opt/tesseract/
      sudo chmod +x /opt/tesseract/tesseract
      
      # Set up environment
      TESSERACT_PATH=/opt/tesseract/tesseract
      echo "TESSERACT_PATH=$TESSERACT_PATH" >> $RENDER_ENV_FILE
      echo "PATH=/opt/tesseract:$PATH" >> $RENDER_ENV_FILE
      
      # Verify Tesseract installation
      $TESSERACT_PATH --version
      $TESSERACT_PATH --list-langs
      
      # Install Python dependencies
      pip install -r requirements.txt
      
      # Verify Tesseract works with Python
      TESSERACT_PATH=$TESSERACT_PATH python test_tesseract.py
      
    startCommand: gunicorn app:app
    envVars:
      - key: RENDER
        value: "true"
      - key: PYTHON_VERSION
        value: 3.11.0
      - key: TESSERACT_PATH
        value: /opt/tesseract/tesseract
      - key: SUPABASE_URL
        sync: false
      - key: SUPABASE_KEY
        sync: false
      - key: SMTP_SERVER
        sync: false
      - key: SMTP_PORT
        sync: false
      - key: SMTP_USERNAME
        sync: false
      - key: SMTP_PASSWORD
        sync: false
      - key: ADMIN_EMAIL
        sync: false

  # Worker Service
  - type: worker
    name: menu-worker
    env: python
    buildCommand: |
      # Install system packages
      sudo apt-get update
      sudo apt-get install -y tesseract-ocr tesseract-ocr-eng libtesseract-dev libleptonica-dev poppler-utils
      
      # Create a persistent directory for Tesseract
      sudo mkdir -p /opt/tesseract
      sudo cp $(which tesseract) /opt/tesseract/
      sudo chmod +x /opt/tesseract/tesseract
      
      # Set up environment
      TESSERACT_PATH=/opt/tesseract/tesseract
      echo "TESSERACT_PATH=$TESSERACT_PATH" >> $RENDER_ENV_FILE
      echo "PATH=/opt/tesseract:$PATH" >> $RENDER_ENV_FILE
      
      # Verify Tesseract installation
      $TESSERACT_PATH --version
      $TESSERACT_PATH --list-langs
      
      # Install Python dependencies
      pip install -r requirements.txt
      
      # Verify Tesseract works with Python
      TESSERACT_PATH=$TESSERACT_PATH python test_tesseract.py
      
    startCommand: python worker.py
    envVars:
      - key: RENDER
        value: "true"
      - key: PYTHON_VERSION
        value: 3.11.0
      - key: TESSERACT_PATH
        value: /opt/tesseract/tesseract
      - key: SUPABASE_URL
        sync: false
      - key: SUPABASE_KEY
        sync: false
      - key: SMTP_SERVER
        sync: false
      - key: SMTP_PORT
        sync: false
      - key: SMTP_USERNAME
        sync: false
      - key: SMTP_PASSWORD
        sync: false 