services:
  # Web App
  - type: web
    name: menu-system
    env: docker
    buildCommand: |
      # Debug output
      echo "Starting build process..."
      pwd
      ls -la
      
      # Build the Docker image
      docker build -t menu-system .
      
      # Test Tesseract in the container
      docker run menu-system python test_tesseract.py
    startCommand: docker run -p 5000:5000 menu-system
    envVars:
      - key: PYTHON_VERSION
        value: 3.11.0
      - key: SUPABASE_URL
        sync: false
      - key: SUPABASE_KEY
        sync: false
      - key: SMTP_SERVER
        sync: false
      - key: SMTP_PORT
        sync: false
      - key: SMTP_USERNAME
        sync: false
      - key: SMTP_PASSWORD
        sync: false
      - key: ADMIN_EMAIL
        sync: false
      - key: TESSDATA_PREFIX
        value: /usr/share/tesseract-ocr/4.00/tessdata
      - key: TESSERACT_PATH
        value: /usr/bin/tesseract
      - key: LD_LIBRARY_PATH
        value: /usr/lib/x86_64-linux-gnu
    healthCheckPath: /
    plan: starter

  # Worker Service
  - type: worker
    name: menu-worker
    env: docker
    buildCommand: |
      # Debug output
      echo "Starting worker build process..."
      pwd
      ls -la
      
      # Build the Docker image
      docker build -f Dockerfile.worker -t menu-worker .
      
      # Test Tesseract in the container
      docker run menu-worker python test_tesseract.py
    startCommand: docker run menu-worker
    envVars:
      - key: PYTHON_VERSION
        value: 3.11.0
      - key: SUPABASE_URL
        sync: false
      - key: SUPABASE_KEY
        sync: false
      - key: SMTP_SERVER
        sync: false
      - key: SMTP_PORT
        sync: false
      - key: SMTP_USERNAME
        sync: false
      - key: SMTP_PASSWORD
        sync: false
      - key: TESSDATA_PREFIX
        value: /usr/share/tesseract-ocr/4.00/tessdata
      - key: TESSERACT_PATH
        value: /usr/bin/tesseract
      - key: LD_LIBRARY_PATH
        value: /usr/lib/x86_64-linux-gnu 