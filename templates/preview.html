{% extends "base.html" %}

{% block content %}
<!-- Add this at the top of the body, before the container -->
<nav class="navbar navbar-expand-lg navbar-dark bg-dark mb-4">
    <div class="container">
        <a class="navbar-brand" href="/">Holly Lea Menus</a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav">
                <li class="nav-item">
                    <a class="nav-link" href="/">Dashboard</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="/system-check">System Status</a>
                </li>
            </ul>
            <ul class="navbar-nav ms-auto">
                <li class="nav-item">
                    <span class="nav-link text-light">
                        <i class="fas fa-clock"></i>
                        <span id="currentTime"></span>
                    </span>
                </li>
            </ul>
        </div>
    </div>
</nav>

<div class="container mt-4">
    <!-- Control Panel Table -->
    <div class="card mb-4">
        <div class="card-body p-0">
            <table class="table table-bordered m-0">
                <tr>
                    <!-- Left Cell: Templates -->
                    <td class="w-25 p-3">
                        <h4 class="mb-3">Menu Templates</h4>
                        <!-- Template List -->
                        <div class="list-group list-group-flush" id="templateList">
                            {% for menu in menus %}
                            <div class="list-group-item d-flex justify-content-between align-items-center">
                                <button class="btn btn-link text-start p-0" onclick="selectTemplate('{{ menu.id }}')">
                                    {{ menu.name }}
                                </button>
                                <button class="btn btn-danger" onclick="deleteTemplate('{{ menu.id }}')" 
                                        title="Delete Menu">
                                    <i class="fas fa-trash"></i> Delete
                                </button>
                            </div>
                            {% endfor %}
                        </div>
                        
                        <!-- File Upload -->
                        <div class="mt-3">
                            <input type="file" 
                                   id="templateFile" 
                                   accept=".pdf,.jpg,.jpeg,.png" 
                                   class="form-control"
                                   onchange="uploadTemplate()">
                        </div>
                    </td>

                    <!-- Second Cell: Menu Rotation -->
                    <td class="w-25 p-3">
                        <h4 class="mb-3">Menu Rotation</h4>
                        <div class="form-group mb-3">
                            <label class="form-label"><strong>Start Date:</strong></label>
                            <input type="date" id="startDate" 
                                   class="form-control"
                                   value="{{ settings.start_date if settings else '' }}"
                                   onchange="updateMenuRotation()">
                        </div>
                        <div class="form-group mb-3">
                            <label class="form-label"><strong>Season:</strong></label>
                            <select id="season" class="form-control" onchange="updateMenuRotation()">
                                <option value="summer" {% if settings and settings.season == 'summer' %}selected{% endif %}>Summer</option>
                                <option value="winter" {% if settings and settings.season == 'winter' %}selected{% endif %}>Winter</option>
                            </select>
                        </div>
                        <div class="form-group mb-3">
                            <label class="form-label"><strong>Season Change Date:</strong></label>
                            <input type="date" id="seasonChangeDate" 
                                   class="form-control"
                                   value="{{ settings.season_change_date if settings else '' }}"
                                   onchange="updateMenuRotation()">
                        </div>
                        <div class="alert alert-info mt-3">
                            <strong>Next Menu to Send:</strong><br>
                            <span id="currentRotation">Select dates to see next menu</span>
                        </div>
                    </td>

                    <!-- Third Cell: Send Settings -->
                    <td class="w-25 p-3">
                        <h4 class="mb-3">Send Settings</h4>
                        <div class="form-group mb-3">
                            <label class="form-label"><strong>Days in Advance to Send:</strong></label>
                            <input type="number" 
                                   id="daysInAdvance" 
                                   class="form-control" 
                                   value="{{ settings.days_in_advance if settings else '3' }}"
                                   min="1" 
                                   max="14"
                                   onchange="updateMenuRotation()">
                        </div>
                        <div class="form-group mb-3">
                            <label for="previewDate" class="form-label"><strong>Select Date:</strong></label>
                            <input type="date" id="previewDate" 
                                   class="form-control"
                                   value="{{ preview_date }}"
                                   onchange="updatePreview()">
                        </div>
                        <div class="form-group mb-3">
                            <label for="emailRecipients" class="d-block"><strong>Email Recipients</strong></label>
                            <input type="text" class="form-control" id="emailRecipients" 
                                   value="{{ ','.join(settings.recipient_emails) if settings and settings.recipient_emails else '' }}"
                                   placeholder="email1@example.com, email2@example.com">
                        </div>
                        <button class="btn btn-primary w-100" onclick="sendMenu()">
                            Send Menu Email
                        </button>
                        <div id="emailSpinner" class="d-none text-center mt-2">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Sending...</span>
                            </div>
                            <div>Sending email...</div>
                        </div>
                        <div class="mt-3">
                            <button class="btn btn-warning w-100" onclick="saveSettings()">
                                <i class="fas fa-save"></i> Save Settings
                            </button>
                        </div>
                    </td>
                </tr>
            </table>
        </div>
    </div>

    <!-- Add auto-send button in a nice spot -->
    <div class="text-end mb-3">
        <button class="btn btn-success" id="autoSendButton" onclick="toggleAutoSend()">
            Start Auto-Send
        </button>
    </div>

    <!-- Preview with smaller size -->
    <div id="menuPreview" class="preview-area p-4 border rounded bg-white mx-auto" style="width: 25%; max-width: 400px;">
        {% if menu and menu.file_url %}
            {% if menu.file_type == 'pdf' %}
                <embed src="{{ menu.file_url }}" 
                       type="application/pdf" 
                       width="100%" 
                       height="300px"
                       style="object-fit: contain;">
            {% else %}
                <img src="{{ menu.file_url }}" 
                     class="img-fluid w-100" 
                     style="max-height: 300px; object-fit: contain;"
                     alt="Menu Preview">
            {% endif %}
        {% else %}
            <div class="text-center text-muted">
                Select a menu to preview
            </div>
        {% endif %}
    </div>
</div>

<script>
let currentTemplateId = null;
let autoSendEnabled = false;
let autoSendInterval;

function uploadTemplate() {
    const fileInput = document.getElementById('templateFile');
    const file = fileInput.files[0];
    if (!file) return;

    const formData = new FormData();
    formData.append('template', file);

    fetch('/api/template', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            location.reload();
        } else {
            alert('Upload failed: ' + data.message);
        }
    });
}

function deleteTemplate(id) {
    if (confirm('Delete this template?')) {
        fetch(`/api/template/${id}`, {
            method: 'DELETE'
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                location.reload();
            }
        });
    }
}

function selectTemplate(id) {
    console.log(`Selecting template: ${id}`);
    currentTemplateId = id;
    
    document.querySelectorAll('#templateList .list-group-item').forEach(item => {
        item.classList.remove('active', 'bg-light');
    });
    event.target.closest('.list-group-item').classList.add('active', 'bg-light');
    
    updatePreview();
}

function updatePreview() {
    if (!currentTemplateId) {
        console.log("No template selected");
        return;
    }
    
    const date = document.getElementById('previewDate').value;
    const previewArea = document.getElementById('menuPreview');
    
    console.log(`Loading preview for template ${currentTemplateId} on date ${date}`);
    
    fetch(`/api/preview?date=${date}&menu_id=${currentTemplateId}`)
        .then(response => {
            console.log("Preview response:", response);
            return response.text();
        })
        .then(html => {
            console.log("Preview content:", html);
            previewArea.innerHTML = html;
        })
        .catch(error => {
            console.error("Preview error:", error);
            previewArea.innerHTML = `
                <div class="alert alert-danger">
                    Failed to load preview: ${error.message}
                </div>
            `;
        });
}

// Initialize preview if template is pre-selected
document.addEventListener('DOMContentLoaded', () => {
    const firstTemplate = document.querySelector('#templateList .list-group-item');
    if (firstTemplate) {
        const templateId = firstTemplate.querySelector('button').getAttribute('onclick').match(/\d+/)[0];
        selectTemplate(templateId);
    }
});

function updateTime() {
    const now = new Date();
    document.getElementById('currentTime').textContent = 
        now.toLocaleString('en-NZ', { 
            dateStyle: 'medium', 
            timeStyle: 'short' 
        });
}

// Update time every second
setInterval(updateTime, 1000);
updateTime();  // Initial update

async function sendMenu() {
    if (!currentTemplateId) {
        alert('Please select a template first');
        return;
    }
    
    const date = document.getElementById('previewDate').value;
    const recipients = document.getElementById('emailRecipients').value.split(',').map(e => e.trim());
    
    if (!date || recipients.length === 0) {
        alert('Please select a date and enter at least one recipient email');
        return;
    }
    
    try {
        const response = await fetch('/api/send-menu', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                menu_id: currentTemplateId,
                date: date,
                recipients: recipients
            })
        });
        
        if (response.ok) {
            alert('Menu sent successfully!');
        } else {
            const error = await response.text();
            alert(`Failed to send menu: ${error}`);
        }
    } catch (error) {
        console.error('Send error:', error);
        alert(`Error sending menu: ${error.message}`);
    }
}

function updateMenuRotation() {
    const startDate = new Date(document.getElementById('startDate').value);
    const seasonChangeDate = new Date(document.getElementById('seasonChangeDate').value);
    const season = document.getElementById('season').value;
    const daysInAdvance = parseInt(document.getElementById('daysInAdvance').value) || 3;
    
    if (!startDate || !seasonChangeDate) return;
    
    // Calculate weeks since start date
    const today = new Date();
    today.setHours(0, 0, 0, 0);  // Reset time to midnight for accurate comparison
    
    const weeksSinceStart = Math.floor((today - startDate) / (7 * 24 * 60 * 60 * 1000));
    
    // Calculate the next period start (next multiple of 2 weeks from start date)
    const nextPeriodStart = new Date(startDate);
    const periodsElapsed = Math.ceil(weeksSinceStart / 2);
    nextPeriodStart.setDate(startDate.getDate() + (periodsElapsed * 14));
    
    // If we're past the send date for this period, move to next period
    const sendDate = new Date(nextPeriodStart);
    sendDate.setDate(sendDate.getDate() - daysInAdvance);
    
    if (today > sendDate) {
        nextPeriodStart.setDate(nextPeriodStart.getDate() + 14);
        sendDate.setDate(sendDate.getDate() + 14);
    }
    
    // Calculate period end (2 weeks after start)
    const nextPeriodEnd = new Date(nextPeriodStart);
    nextPeriodEnd.setDate(nextPeriodStart.getDate() + 13); // 2 weeks - 1 day
    
    // Determine menu pair (1&2 or 3&4)
    const isOddPeriod = Math.floor((periodsElapsed + (today > sendDate ? 1 : 0)) % 2) === 0;
    const menuPair = isOddPeriod ? "1 & 2" : "3 & 4";
    
    const formatDate = (date) => date.toLocaleDateString('en-NZ', { 
        day: 'numeric', 
        month: 'long'
    });
    
    // Update display
    document.getElementById('currentRotation').innerHTML = `
        <strong>${formatDate(nextPeriodStart)} - ${formatDate(nextPeriodEnd)}</strong><br>
        ${season.charAt(0).toUpperCase() + season.slice(1)} Menus ${menuPair}
        (Week ${((periodsElapsed + (today > sendDate ? 1 : 0)) % 4) + 1} of 4)<br>
        <small class="text-muted">Will send on: ${formatDate(sendDate)}</small>
    `;
}

// Add event listener for start date changes
document.getElementById('startDate').addEventListener('change', updateMenuRotation);

async function checkAndSendMenu() {
    const nextSendDate = new Date(nextPeriodStart);
    nextSendDate.setDate(nextSendDate.getDate() - daysInAdvance);
    
    const today = new Date();
    if (today.toDateString() === nextSendDate.toDateString()) {
        await sendMenu();
    }
}

async function saveSettings() {
    const settings = {
        start_date: document.getElementById('startDate').value,
        season: document.getElementById('season').value,
        season_change_date: document.getElementById('seasonChangeDate').value,
        days_in_advance: parseInt(document.getElementById('daysInAdvance').value),
        recipient_emails: document.getElementById('emailRecipients').value.split(',').map(e => e.trim())
    };
    
    try {
        const response = await fetch('/api/settings', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(settings)
        });
        
        if (response.ok) {
            alert('Settings saved successfully!');
        } else {
            const error = await response.text();
            alert(`Failed to save settings: ${error}`);
        }
    } catch (error) {
        alert(`Error saving settings: ${error}`);
    }
}
</script>
{% endblock %}

{% block scripts %}
<!-- Your existing preview page scripts here -->
{% endblock %} 