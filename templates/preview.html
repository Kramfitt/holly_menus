<!-- Add this at the top of the body, before the container -->
<nav class="navbar navbar-expand-lg navbar-dark bg-dark mb-4">
    <div class="container">
        <a class="navbar-brand" href="/">Holly Lea Menus</a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav">
                <li class="nav-item">
                    <a class="nav-link" href="/">Dashboard</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="/system-check">System Status</a>
                </li>
            </ul>
            <ul class="navbar-nav ms-auto">
                <li class="nav-item">
                    <span class="nav-link text-light">
                        <i class="fas fa-clock"></i>
                        <span id="currentTime"></span>
                    </span>
                </li>
            </ul>
        </div>
    </div>
</nav>

<div class="container mt-4">
    <div class="row">
        <!-- Left Column: Templates -->
        <div class="col-md-4">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0">Menu Templates</h4>
                </div>
                <div class="card-body p-0">
                    <!-- Template List -->
                    <div class="list-group list-group-flush" id="templateList">
                        {% for menu in menus %}
                        <div class="list-group-item d-flex justify-content-between align-items-center">
                            <button class="btn btn-link text-start p-0" onclick="selectTemplate('{{ menu.id }}')">
                                {{ menu.name }}
                            </button>
                            <button class="btn btn-danger" onclick="deleteTemplate('{{ menu.id }}')" 
                                    title="Delete Menu">
                                <i class="fas fa-trash"></i> Delete
                            </button>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                <!-- Simple File Upload -->
                <div class="card-footer">
                    <input type="file" 
                           id="templateFile" 
                           accept=".pdf,.jpg,.jpeg,.png" 
                           class="form-control"
                           onchange="uploadTemplate()">
                </div>
            </div>
        </div>

        <!-- Right Column: Date & Preview -->
        <div class="col-md-8">
            <!-- Date Selector -->
            <div class="card mb-3">
                <div class="card-body">
                    <div class="form-group">
                        <label class="form-label"><strong>Select Date:</strong></label>
                        <input type="date" id="previewDate" 
                               class="form-control"
                               value="{{ preview_date }}"
                               onchange="updatePreview()">
                    </div>
                </div>
            </div>

            <!-- Preview Area -->
            <div class="card">
                <div class="card-header bg-light">
                    <h4 class="mb-0">Preview</h4>
                </div>
                <div class="card-body">
                    <div id="menuPreview" class="preview-area p-4 border rounded bg-white">
                        {% if menu and menu.file_url %}
                            {% if menu.file_type == 'pdf' %}
                                <embed src="{{ menu.file_url }}" 
                                       type="application/pdf" 
                                       width="100%" 
                                       height="600px">
                            {% else %}
                                <img src="{{ menu.file_url }}" 
                                     class="img-fluid" 
                                     alt="Menu Preview">
                            {% endif %}
                        {% else %}
                            <div class="text-center text-muted">
                                Select a menu to preview
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Add this right after your preview div -->
            <div class="mt-3">
                <div class="form-group">
                    <label for="emailRecipients">Email Recipients (comma-separated)</label>
                    <input type="text" class="form-control" id="emailRecipients" 
                           placeholder="email1@example.com, email2@example.com">
                </div>
                <button class="btn btn-primary mt-2" onclick="sendMenu()">
                    Send Menu Email
                </button>
            </div>
        </div>
    </div>
</div>

<script>
let currentTemplateId = null;

function uploadTemplate() {
    const fileInput = document.getElementById('templateFile');
    const file = fileInput.files[0];
    if (!file) return;

    const formData = new FormData();
    formData.append('template', file);

    fetch('/api/template', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            location.reload();
        } else {
            alert('Upload failed: ' + data.message);
        }
    });
}

function deleteTemplate(id) {
    if (confirm('Delete this template?')) {
        fetch(`/api/template/${id}`, {
            method: 'DELETE'
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                location.reload();
            }
        });
    }
}

function selectTemplate(id) {
    console.log(`Selecting template: ${id}`);
    currentTemplateId = id;
    
    document.querySelectorAll('#templateList .list-group-item').forEach(item => {
        item.classList.remove('active', 'bg-light');
    });
    event.target.closest('.list-group-item').classList.add('active', 'bg-light');
    
    updatePreview();
}

function updatePreview() {
    if (!currentTemplateId) {
        console.log("No template selected");
        return;
    }
    
    const date = document.getElementById('previewDate').value;
    const previewArea = document.getElementById('menuPreview');
    
    console.log(`Loading preview for template ${currentTemplateId} on date ${date}`);
    
    fetch(`/api/preview?date=${date}&menu_id=${currentTemplateId}`)
        .then(response => {
            console.log("Preview response:", response);
            return response.text();
        })
        .then(html => {
            console.log("Preview content:", html);
            previewArea.innerHTML = html;
        })
        .catch(error => {
            console.error("Preview error:", error);
            previewArea.innerHTML = `
                <div class="alert alert-danger">
                    Failed to load preview: ${error.message}
                </div>
            `;
        });
}

// Initialize preview if template is pre-selected
document.addEventListener('DOMContentLoaded', () => {
    const firstTemplate = document.querySelector('#templateList .list-group-item');
    if (firstTemplate) {
        const templateId = firstTemplate.querySelector('button').getAttribute('onclick').match(/\d+/)[0];
        selectTemplate(templateId);
    }
});

function updateTime() {
    const now = new Date();
    document.getElementById('currentTime').textContent = 
        now.toLocaleString('en-NZ', { 
            dateStyle: 'medium', 
            timeStyle: 'short' 
        });
}

// Update time every second
setInterval(updateTime, 1000);
updateTime();  // Initial update

async function sendMenu() {
    const menuId = document.getElementById('menuSelect').value;
    const startDate = document.getElementById('startDate').value;
    const recipients = document.getElementById('emailRecipients').value.split(',').map(e => e.trim());
    
    if (!menuId || !startDate || recipients.length === 0) {
        alert('Please select a menu, date, and enter at least one recipient');
        return;
    }
    
    try {
        const response = await fetch('/api/send-menu', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                menu_id: menuId,
                date: startDate,
                recipients: recipients
            })
        });
        
        if (response.ok) {
            alert('Menu sent successfully!');
        } else {
            const error = await response.text();
            alert(`Failed to send menu: ${error}`);
        }
    } catch (error) {
        alert(`Error sending menu: ${error}`);
    }
}
</script> 