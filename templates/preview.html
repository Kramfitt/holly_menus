{% extends "base.html" %}

{% block content %}
<!-- Add this at the top of the body, before the container -->
<nav class="navbar navbar-expand-lg navbar-dark bg-dark mb-4">
    <div class="container">
        <a class="navbar-brand" href="/">Holly Lea Menus</a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav">
                <li class="nav-item">
                    <a class="nav-link" href="/">Dashboard</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="/system-check">System Status</a>
                </li>
            </ul>
            <ul class="navbar-nav ms-auto">
                <li class="nav-item">
                    <span class="nav-link text-light">
                        <i class="fas fa-clock"></i>
                        <span id="currentTime"></span>
                    </span>
                </li>
            </ul>
        </div>
    </div>
</nav>

<div class="container">
    <h2>Menu Preview & Send</h2>
    
    <!-- Settings Form -->
    <div class="card mb-4">
        <div class="card-body">
            <h5 class="card-title">1. Configure Menu Settings</h5>
            <form id="settingsForm">
                <div class="mb-3">
                    <label for="startDate" class="form-label">Rotation Start Date</label>
                    <input type="date" class="form-control" id="startDate" 
                           value="{{ settings.start_date if settings else '' }}">
                    <small class="text-muted">This is when your 4-week menu rotation cycle begins</small>
                </div>
                <div class="mb-3">
                    <label class="form-label"><strong>Season:</strong></label>
                    <select id="season" class="form-control" onchange="updateMenuRotation()">
                        <option value="summer" {% if settings and settings.season == 'summer' %}selected{% endif %}>Summer</option>
                        <option value="winter" {% if settings and settings.season == 'winter' %}selected{% endif %}>Winter</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label class="form-label"><strong>Season Change Date:</strong></label>
                    <input type="date" id="seasonChangeDate" 
                           class="form-control"
                           value="{{ settings.season_change_date if settings else '' }}"
                           onchange="updateMenuRotation()">
                </div>
                <div class="alert alert-info mt-3">
                    <strong>Next Menu to Send:</strong><br>
                    <span id="currentRotation">Select dates to see next menu</span>
                </div>
            </form>
        </div>
    </div>

    <!-- Add auto-send button in a nice spot -->
    <div class="text-end mb-3">
        <button class="btn btn-success" id="autoSendButton" onclick="toggleAutoSend()">
            Start Auto-Send
        </button>
    </div>

    <!-- Menu Preview -->
    <div class="card mb-4">
        <div class="card-body">
            <h5 class="card-title">2. Preview Menu</h5>
            
            <!-- Date Selection for Preview -->
            <div class="mb-4">
                <label for="previewDate" class="form-label">Choose a Date to Preview</label>
                <input type="date" class="form-control" id="previewDate" 
                       onchange="updateMenuRotation()"
                       value="{{ preview_date.strftime('%Y-%m-%d') }}">
                <small class="text-muted">Select any date to see which menu would be used on that day</small>
            </div>
            
            <!-- Rotation Display -->
            <div id="currentRotation" class="mb-3 p-3 bg-light rounded">
                <strong>Menu Rotation for Selected Date:</strong>
                <div id="rotationDetails">Loading...</div>
            </div>
            
            <!-- Menu Selection and Preview -->
            <div class="mb-3">
                <label for="menuSelect" class="form-label">Select Menu to Preview</label>
                <select class="form-control" id="menuSelect">
                    <option value="">Select a menu...</option>
                    {% for menu in menus %}
                    <option value="{{ menu.id }}">{{ menu.name }}</option>
                    {% endfor %}
                </select>
            </div>

            <!-- Loading and Error States -->
            <div id="previewStatus" class="mb-3" style="display: none;">
                <div class="alert" role="alert"></div>
            </div>

            <!-- Preview Container -->
            <div class="preview-container" style="width: 100%; height: 800px; overflow: hidden;">
                <div id="loadingSpinner" style="display: none; text-align: center; padding: 20px;">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
                <img id="menuPreview" 
                     style="width: 100%; height: auto; object-fit: contain; display: none;" 
                     alt="Menu Preview">
            </div>
        </div>
    </div>
</div>

<style>
.preview-container {
    background-color: #f8f9fa;
    border-radius: 8px;
    padding: 15px;
    margin-top: 20px;
}

#menuPreview {
    max-width: 100%;
    display: block;
    margin: 0 auto;
}
</style>

<script>
let currentTemplateId = null;
let autoSendEnabled = false;
let autoSendInterval;

function uploadTemplate() {
    const fileInput = document.getElementById('templateFile');
    const file = fileInput.files[0];
    if (!file) return;

    const formData = new FormData();
    formData.append('template', file);

    fetch('/api/template', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            location.reload();
        } else {
            alert('Upload failed: ' + data.message);
        }
    });
}

function deleteTemplate(id) {
    if (confirm('Delete this template?')) {
        fetch(`/api/template/${id}`, {
            method: 'DELETE'
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                location.reload();
            }
        });
    }
}

function selectTemplate(id) {
    console.log(`Selecting template: ${id}`);
    currentTemplateId = id;
    
    document.querySelectorAll('#templateList .list-group-item').forEach(item => {
        item.classList.remove('active', 'bg-light');
    });
    event.target.closest('.list-group-item').classList.add('active', 'bg-light');
    
    updatePreview();
}

function updatePreview() {
    if (!currentTemplateId) {
        console.log("No template selected");
        return;
    }
    
    const date = document.getElementById('previewDate').value;
    const previewArea = document.getElementById('menuPreview');
    
    console.log(`Loading preview for template ${currentTemplateId} on date ${date}`);
    
    fetch(`/api/preview?date=${date}&menu_id=${currentTemplateId}`)
        .then(response => {
            console.log("Preview response:", response);
            return response.text();
        })
        .then(html => {
            console.log("Preview content:", html);
            previewArea.innerHTML = html;
        })
        .catch(error => {
            console.error("Preview error:", error);
            previewArea.innerHTML = `
                <div class="alert alert-danger">
                    Failed to load preview: ${error.message}
                </div>
            `;
        });
}

// Initialize preview if template is pre-selected
document.addEventListener('DOMContentLoaded', () => {
    const firstTemplate = document.querySelector('#templateList .list-group-item');
    if (firstTemplate) {
        const templateId = firstTemplate.querySelector('button').getAttribute('onclick').match(/\d+/)[0];
        selectTemplate(templateId);
    }
});

function updateTime() {
    const now = new Date();
    document.getElementById('currentTime').textContent = 
        now.toLocaleString('en-NZ', { 
            dateStyle: 'medium', 
            timeStyle: 'short' 
        });
}

// Update time every second
setInterval(updateTime, 1000);
updateTime();  // Initial update

async function sendMenu() {
    if (!currentTemplateId) {
        alert('Please select a template first');
        return;
    }
    
    const date = document.getElementById('previewDate').value;
    const recipients = document.getElementById('emailRecipients').value.split(',').map(e => e.trim());
    
    if (!date || recipients.length === 0) {
        alert('Please select a date and enter at least one recipient email');
        return;
    }
    
    try {
        const response = await fetch('/api/send-menu', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                menu_id: currentTemplateId,
                date: date,
                recipients: recipients
            })
        });
        
        if (response.ok) {
            alert('Menu sent successfully!');
        } else {
            const error = await response.text();
            alert(`Failed to send menu: ${error}`);
        }
    } catch (error) {
        console.error('Send error:', error);
        alert(`Error sending menu: ${error.message}`);
    }
}

function updateMenuRotation() {
    const startDate = new Date(document.getElementById('startDate').value);
    const seasonChangeDate = new Date(document.getElementById('seasonChangeDate').value);
    const season = document.getElementById('season').value;
    const daysInAdvance = parseInt(document.getElementById('daysInAdvance').value) || 3;
    
    if (!startDate || !seasonChangeDate) return;
    
    // Calculate weeks since start date
    const today = new Date();
    today.setHours(0, 0, 0, 0);  // Reset time to midnight for accurate comparison
    
    const weeksSinceStart = Math.floor((today - startDate) / (7 * 24 * 60 * 60 * 1000));
    
    // Calculate the next period start (next multiple of 2 weeks from start date)
    const nextPeriodStart = new Date(startDate);
    const periodsElapsed = Math.ceil(weeksSinceStart / 2);
    nextPeriodStart.setDate(startDate.getDate() + (periodsElapsed * 14));
    
    // If we're past the send date for this period, move to next period
    const sendDate = new Date(nextPeriodStart);
    sendDate.setDate(sendDate.getDate() - daysInAdvance);
    
    if (today > sendDate) {
        nextPeriodStart.setDate(nextPeriodStart.getDate() + 14);
        sendDate.setDate(sendDate.getDate() + 14);
    }
    
    // Calculate period end (2 weeks after start)
    const nextPeriodEnd = new Date(nextPeriodStart);
    nextPeriodEnd.setDate(nextPeriodStart.getDate() + 13); // 2 weeks - 1 day
    
    // Determine menu pair (1&2 or 3&4)
    const isOddPeriod = Math.floor((periodsElapsed + (today > sendDate ? 1 : 0)) % 2) === 0;
    const menuPair = isOddPeriod ? "1 & 2" : "3 & 4";
    
    const formatDate = (date) => date.toLocaleDateString('en-NZ', { 
        day: 'numeric', 
        month: 'long'
    });
    
    // Update display
    document.getElementById('currentRotation').innerHTML = `
        <strong>${formatDate(nextPeriodStart)} - ${formatDate(nextPeriodEnd)}</strong><br>
        ${season.charAt(0).toUpperCase() + season.slice(1)} Menus ${menuPair}
        (Week ${((periodsElapsed + (today > sendDate ? 1 : 0)) % 4) + 1} of 4)<br>
        <small class="text-muted">Will send on: ${formatDate(sendDate)}</small>
    `;
}

// Add event listener for start date changes
document.getElementById('startDate').addEventListener('change', updateMenuRotation);

async function checkAndSendMenu() {
    const nextSendDate = new Date(nextPeriodStart);
    nextSendDate.setDate(nextSendDate.getDate() - daysInAdvance);
    
    const today = new Date();
    if (today.toDateString() === nextSendDate.toDateString()) {
        await sendMenu();
    }
}

async function saveSettings() {
    const settings = {
        start_date: document.getElementById('startDate').value,
        season: document.getElementById('season').value,
        season_change_date: document.getElementById('seasonChangeDate').value,
        days_in_advance: parseInt(document.getElementById('daysInAdvance').value),
        recipient_emails: document.getElementById('emailRecipients').value.split(',').map(e => e.trim())
    };
    
    try {
        const response = await fetch('/api/settings', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(settings)
        });
        
        if (response.ok) {
            alert('Settings saved successfully!');
        } else {
            const error = await response.text();
            alert(`Failed to save settings: ${error}`);
        }
    } catch (error) {
        alert(`Error saving settings: ${error}`);
    }
}
</script>
{% endblock %}

{% block scripts %}
<script>
function showStatus(message, type = 'info') {
    const status = document.getElementById('previewStatus');
    const alert = status.querySelector('.alert');
    alert.className = `alert alert-${type}`;
    alert.textContent = message;
    status.style.display = 'block';
}

function showLoading(show = true) {
    document.getElementById('loadingSpinner').style.display = show ? 'block' : 'none';
    document.getElementById('menuPreview').style.display = show ? 'none' : 'block';
}

async function updateMenuPreview() {
    const selectedMenu = document.getElementById('menuSelect')?.value;
    if (!selectedMenu) {
        document.getElementById('menuPreview').style.display = 'none';
        return;
    }
    
    showLoading(true);
    showStatus('Loading menu preview...', 'info');
    
    try {
        const response = await fetch(`/api/menus/${selectedMenu}`);
        if (!response.ok) throw new Error('Failed to fetch menu data');
        
        const menuData = await response.json();
        console.log('Menu data:', menuData);  // Debug log
        
        if (menuData.url) {
            const img = document.getElementById('menuPreview');
            img.onerror = () => {
                showStatus('Failed to load menu image. Please try again.', 'danger');
                showLoading(false);
            };
            img.onload = () => {
                showStatus('Menu loaded successfully!', 'success');
                showLoading(false);
            };
            img.src = menuData.url;
        } else {
            throw new Error('No menu URL found');
        }
    } catch (error) {
        console.error('Preview error:', error);
        showStatus(`Error loading menu: ${error.message}`, 'danger');
        showLoading(false);
    }
}

function updateMenuRotation() {
    const previewDate = document.getElementById('previewDate').value;
    if (!previewDate) return;
    
    document.getElementById('rotationDetails').innerHTML = 'Loading...';
    
    fetch(`/api/calculate-menu?date=${previewDate}`)
        .then(response => response.json())
        .then(data => {
            document.getElementById('rotationDetails').innerHTML = `
                <div class="mt-2">
                    <strong>Date:</strong> ${new Date(previewDate).toLocaleDateString()}<br>
                    <strong>Season:</strong> ${data.season}<br>
                    <strong>Week:</strong> ${data.week_number} of 4<br>
                    <strong>Menu Pair:</strong> ${data.menu_pair || 'Not calculated'}
                </div>
            `;
        })
        .catch(error => {
            console.error('Error:', error);
            document.getElementById('rotationDetails').innerHTML = 
                `<div class="text-danger">Error calculating menu rotation</div>`;
        });
}

// Add event listeners
document.addEventListener('DOMContentLoaded', function() {
    const menuSelect = document.getElementById('menuSelect');
    if (menuSelect) {
        menuSelect.addEventListener('change', updateMenuPreview);
    }
    
    updateMenuRotation();
});
</script>
{% endblock %} 