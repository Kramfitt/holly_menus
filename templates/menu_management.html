{% extends "base.html" %}

{% block content %}
<div class="container">
    <div class="row mb-4">
        <div class="col">
            <div class="d-flex gap-3">
                <a href="/" class="btn btn-outline-primary">
                    <i class="fas fa-home"></i> Dashboard
                </a>
                <a href="/menus" class="btn btn-outline-primary">
                    <i class="fas fa-eye"></i> Settings
                </a>
                <a href="/preview" class="btn btn-outline-primary active">
                    <i class="fas fa-eye"></i> Preview
                </a>
                <a href="/system-check" class="btn btn-outline-primary">
                    <i class="fas fa-cog"></i> System Status
                </a>
            </div>
        </div>
    </div>
    <h2>Settings & File Management</h2>
    
    <!-- Menu Settings -->
    <div class="card mb-4">
        <div class="card-body">
            <h5 class="card-title">Menu Settings</h5>
            <form id="settingsForm">
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="startDate" class="form-label">Rotation Start Date</label>
                            <input type="date" class="form-control" id="startDate" 
                                   value="{{ settings.start_date if settings else '' }}" required>
                            <small class="text-muted">When your menu rotation begins</small>
                        </div>
                        <div class="mb-3">
                            <label for="season" class="form-label">Current Season</label>
                            <select class="form-control" id="season" required>
                                <option value="summer" {% if settings and settings.season == 'summer' %}selected{% endif %}>Summer</option>
                                <option value="winter" {% if settings and settings.season == 'winter' %}selected{% endif %}>Winter</option>
                            </select>
                            <small class="text-muted">
                                Will automatically switch when Season Change Date is reached
                            </small>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="seasonChangeDate" class="form-label">Season Change Date</label>
                            <input type="date" class="form-control" id="seasonChangeDate" 
                                   value="{{ settings.season_change_date if settings else '' }}">
                            <small class="text-muted">When to switch seasons (optional)</small>
                        </div>
                        <div class="mb-3">
                            <label for="daysInAdvance" class="form-label">Days in Advance</label>
                            <input type="number" class="form-control" id="daysInAdvance" 
                                   value="{{ settings.days_in_advance if settings else 14 }}" min="1" max="30">
                            <small class="text-muted">How many days before period start to send menu</small>
                        </div>
                    </div>
                </div>
                
                <div class="mb-3">
                    <label for="recipients" class="form-label">Email Recipients</label>
                    <textarea class="form-control" id="recipients" rows="2" 
                              placeholder="Enter email addresses, separated by commas">{{ settings.recipient_emails|join(', ') if settings and settings.recipient_emails else '' }}</textarea>
                    <small class="text-muted">Who should receive the menu emails</small>
                </div>
                
                <button type="submit" class="btn btn-primary">Save Settings</button>
            </form>
        </div>
    </div>

    <!-- Menu Files Section -->
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="mb-0">Menu Files</h5>
        </div>
        <div class="card-body">
            <table class="table">
                <thead>
                    <tr>
                        <th>Menu Type</th>
                        <th>Current File</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for season in ['Summer', 'Winter'] %}
                        {% for week in ['1', '2', '3', '4'] %}
                            <tr>
                                <td>{{ season }} Week {{ week }}</td>
                                <td>
                                    {% set menu_name = season + 'Week' + week %}
                                    {% if menus and menu_name in menus %}
                                        {{ menus[menu_name] }}
                                    {% else %}
                                        <span class="text-muted">No file uploaded</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <div class="btn-group">
                                        <button class="btn btn-primary btn-sm" onclick="openFileUpload('{{ season }}Week{{ week }}')">
                                            <i class="fas fa-upload"></i> Update
                                        </button>
                                        {% if menus and menu_name in menus %}
                                            <button class="btn btn-danger btn-sm" onclick="deleteMenu('{{ season }}Week{{ week }}')">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        {% endif %}
                                    </div>
                                </td>
                            </tr>
                        {% endfor %}
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Hidden file input for uploads -->
    <input type="file" id="menuFileInput" style="display: none;" accept=".pdf">
</div>

<!-- Update the JavaScript -->
<script>
function showMenu(url, name) {
    document.getElementById('menuListView').style.display = 'none';
    document.getElementById('menuPreviewView').style.display = 'block';
    document.getElementById('previewTitle').textContent = `Viewing: ${name}`;
    document.getElementById('menuPreviewImage').src = url;
    
    // Scroll to the preview
    document.getElementById('menuPreviewView').scrollIntoView({ behavior: 'smooth' });
}

function showMenuList() {
    document.getElementById('menuPreviewView').style.display = 'none';
    document.getElementById('menuListView').style.display = 'block';
}

// Settings form submission
document.getElementById('settingsForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const settings = {
        start_date: document.getElementById('startDate').value,
        season: document.getElementById('season').value,
        season_change_date: document.getElementById('seasonChangeDate').value,
        days_in_advance: parseInt(document.getElementById('daysInAdvance').value),
        recipient_emails: document.getElementById('recipients').value.split(',').map(email => email.trim())
    };
    
    try {
        const response = await fetch('/api/settings', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(settings)
        });
        
        if (response.ok) {
            alert('Settings saved successfully!');
        } else {
            const error = await response.text();
            alert(`Failed to save settings: ${error}`);
        }
    } catch (error) {
        alert(`Error saving settings: ${error}`);
    }
});

function openFileUpload(menuName) {
    const input = document.getElementById('menuFileInput');
    input.setAttribute('data-menu-name', menuName);
    input.click();
}

async function deleteMenu(menuName) {
    if (!confirm(`Are you sure you want to delete ${menuName}?`)) {
        return;
    }
    
    try {
        const response = await fetch('/api/menus/' + menuName, {
            method: 'DELETE'
        });
        
        if (response.ok) {
            alert('Menu deleted successfully');
            location.reload();
        } else {
            const error = await response.text();
            alert(`Failed to delete menu: ${error}`);
        }
    } catch (error) {
        alert(`Error deleting menu: ${error}`);
    }
}

// File upload handler
document.getElementById('menuFileInput').addEventListener('change', async function(e) {
    const file = e.target.files[0];
    if (!file) return;
    
    const menuName = this.getAttribute('data-menu-name');
    const formData = new FormData();
    formData.append('file', file);
    formData.append('name', menuName);
    
    try {
        const response = await fetch('/api/menus', {
            method: 'POST',
            body: formData
        });
        
        if (response.ok) {
            alert('Menu uploaded successfully');
            location.reload();
        } else {
            const error = await response.text();
            alert(`Failed to upload menu: ${error}`);
        }
    } catch (error) {
        alert(`Error uploading menu: ${error}`);
    }
});
</script>
{% endblock %} 