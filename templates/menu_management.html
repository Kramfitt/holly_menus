{% extends "base.html" %}

{% block content %}
<div class="container">
    <h2>Settings & File Management</h2>
    
    <!-- Menu Settings -->
    <div class="card mb-4">
        <div class="card-body">
            <h5 class="card-title">Menu Settings</h5>
            <form id="settingsForm">
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="startDate" class="form-label">Rotation Start Date</label>
                            <input type="date" class="form-control" id="startDate" 
                                   value="{{ settings.start_date if settings else '' }}" required>
                            <small class="text-muted">When your menu rotation begins</small>
                        </div>
                        <div class="mb-3">
                            <label for="season" class="form-label">Current Season</label>
                            <select class="form-control" id="season" required>
                                <option value="summer" {% if settings and settings.season == 'summer' %}selected{% endif %}>Summer</option>
                                <option value="winter" {% if settings and settings.season == 'winter' %}selected{% endif %}>Winter</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="seasonChangeDate" class="form-label">Season Change Date</label>
                            <input type="date" class="form-control" id="seasonChangeDate" 
                                   value="{{ settings.season_change_date if settings else '' }}">
                            <small class="text-muted">When to switch seasons (optional)</small>
                        </div>
                        <div class="mb-3">
                            <label for="daysInAdvance" class="form-label">Days in Advance</label>
                            <input type="number" class="form-control" id="daysInAdvance" 
                                   value="{{ settings.days_in_advance if settings else 14 }}" min="1" max="30">
                            <small class="text-muted">How many days before period start to send menu</small>
                        </div>
                    </div>
                </div>
                
                <div class="mb-3">
                    <label for="recipients" class="form-label">Email Recipients</label>
                    <textarea class="form-control" id="recipients" rows="2" 
                              placeholder="Enter email addresses, separated by commas">{{ settings.recipient_emails|join(', ') if settings and settings.recipient_emails else '' }}</textarea>
                    <small class="text-muted">Who should receive the menu emails</small>
                </div>
                
                <button type="submit" class="btn btn-primary">Save Settings</button>
            </form>
        </div>
    </div>

    <!-- Menu File Management -->
    <div class="card">
        <div class="card-body">
            <h5 class="card-title">Menu Files</h5>
            
            <!-- Upload Form -->
            <form id="uploadForm" class="mb-4">
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="menuName" class="form-label">Menu Name</label>
                            <select class="form-control" id="menuName" required>
                                <option value="">Select menu name...</option>
                                <optgroup label="Summer Menus">
                                    <option value="SummerWeek1">Summer Week 1</option>
                                    <option value="SummerWeek2">Summer Week 2</option>
                                    <option value="SummerWeek3">Summer Week 3</option>
                                    <option value="SummerWeek4">Summer Week 4</option>
                                </optgroup>
                                <optgroup label="Winter Menus">
                                    <option value="WinterWeek1">Winter Week 1</option>
                                    <option value="WinterWeek2">Winter Week 2</option>
                                    <option value="WinterWeek3">Winter Week 3</option>
                                    <option value="WinterWeek4">Winter Week 4</option>
                                </optgroup>
                            </select>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="menuFile" class="form-label">Menu File</label>
                            <input type="file" class="form-control" id="menuFile" accept="image/*" required>
                        </div>
                    </div>
                </div>
                <button type="submit" class="btn btn-success">Upload Menu</button>
            </form>

            <!-- Menu List -->
            <h6>Current Menus</h6>
            <div class="table-responsive">
                <table class="table">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Preview</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="menuList">
                        {% for menu in menus %}
                        <tr>
                            <td>{{ menu.name }}</td>
                            <td>
                                <img src="{{ menu.file_url }}" 
                                     style="max-height: 50px; cursor: pointer;"
                                     onclick="showMenuPreview('{{ menu.file_url }}')"
                                     alt="{{ menu.name }}">
                            </td>
                            <td>
                                <button class="btn btn-danger btn-sm" 
                                        onclick="deleteMenu('{{ menu.id }}', '{{ menu.name }}')">
                                    <i class="fas fa-trash"></i> Delete
                                </button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Preview Modal -->
<div class="modal fade" id="previewModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Menu Preview</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <img id="modalPreview" src="" style="width: 100%;" alt="Menu Preview">
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
// Settings form submission
document.getElementById('settingsForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const settings = {
        start_date: document.getElementById('startDate').value,
        season: document.getElementById('season').value,
        season_change_date: document.getElementById('seasonChangeDate').value,
        days_in_advance: parseInt(document.getElementById('daysInAdvance').value),
        recipient_emails: document.getElementById('recipients').value.split(',').map(email => email.trim())
    };
    
    try {
        const response = await fetch('/api/settings', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(settings)
        });
        
        if (response.ok) {
            alert('Settings saved successfully!');
        } else {
            const error = await response.text();
            alert(`Failed to save settings: ${error}`);
        }
    } catch (error) {
        alert(`Error saving settings: ${error}`);
    }
});

// Your existing upload/delete/preview JavaScript
</script>
{% endblock %} 